
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dispel.providers.ads.tasks.grip &#8212; dispel 0.1.dev1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../../../../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=a746c00c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../../../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script src="../../../../../_static/documentation_options.js?v=6aee1ebc"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dispel/providers/ads/tasks/grip';</script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../../_static/dispel-logo.png" class="logo__image only-light" alt="dispel 0.1.dev1 documentation - Home"/>
    <script>document.write(`<img src="../../../../../_static/dispel-logo.png" class="logo__image only-dark" alt="dispel 0.1.dev1 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../usage.html">
                        Usage
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../measures.html">
                        Measures
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../api/modules.html">
                        dispel
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../contributing.html">
                        Contributing
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../usage.html">
                        Usage
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../measures.html">
                        Measures
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../api/modules.html">
                        dispel
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../contributing.html">
                        Contributing
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../providers.html" class="nav-link">dispel.providers</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">dispel.provi...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for dispel.providers.ads.tasks.grip</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Grip Force test related functionality.</span>

<span class="sd">This module contains functionality to extract measures for the *Grip Force*</span>
<span class="sd">test (GRIP).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">dispel.data.levels</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">Level</span>
<span class="kn">from</span> <span class="nn">dispel.data.measures</span> <span class="kn">import</span> <span class="n">MeasureValueDefinitionPrototype</span>
<span class="kn">from</span> <span class="nn">dispel.data.raw</span> <span class="kn">import</span> <span class="n">DEFAULT_COLUMNS</span><span class="p">,</span> <span class="n">USER_ACC_MAP</span><span class="p">,</span> <span class="n">RawDataValueDefinition</span>
<span class="kn">from</span> <span class="nn">dispel.data.validators</span> <span class="kn">import</span> <span class="n">GREATER_THAN_ZERO</span><span class="p">,</span> <span class="n">RangeValidator</span>
<span class="kn">from</span> <span class="nn">dispel.data.values</span> <span class="kn">import</span> <span class="n">AbbreviatedValue</span> <span class="k">as</span> <span class="n">AV</span>
<span class="kn">from</span> <span class="nn">dispel.data.values</span> <span class="kn">import</span> <span class="n">AVEnum</span>
<span class="kn">from</span> <span class="nn">dispel.processing</span> <span class="kn">import</span> <span class="n">ProcessingStep</span>
<span class="kn">from</span> <span class="nn">dispel.processing.extract</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_AGGREGATIONS</span><span class="p">,</span>
    <span class="n">AggregateRawDataSetColumn</span><span class="p">,</span>
    <span class="n">ExtractMultipleStep</span><span class="p">,</span>
    <span class="n">ExtractStep</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dispel.processing.level</span> <span class="kn">import</span> <span class="n">LevelFilter</span><span class="p">,</span> <span class="n">LevelIdFilter</span><span class="p">,</span> <span class="n">ProcessingStepGroup</span>
<span class="kn">from</span> <span class="nn">dispel.processing.modalities</span> <span class="kn">import</span> <span class="n">HandModality</span><span class="p">,</span> <span class="n">SensorModality</span>
<span class="kn">from</span> <span class="nn">dispel.processing.transform</span> <span class="kn">import</span> <span class="n">ConcatenateLevels</span><span class="p">,</span> <span class="n">TransformStep</span>
<span class="kn">from</span> <span class="nn">dispel.providers.ads.data</span> <span class="kn">import</span> <span class="n">ADSReading</span>
<span class="kn">from</span> <span class="nn">dispel.providers.generic.sensor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FREQ_100HZ</span><span class="p">,</span>
    <span class="n">RenameColumns</span><span class="p">,</span>
    <span class="n">Resample</span><span class="p">,</span>
    <span class="n">SetTimestampIndex</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dispel.providers.generic.tremor</span> <span class="kn">import</span> <span class="n">TremorMeasures</span>
<span class="kn">from</span> <span class="nn">dispel.providers.registry</span> <span class="kn">import</span> <span class="n">process_factory</span>
<span class="kn">from</span> <span class="nn">dispel.stats.core</span> <span class="kn">import</span> <span class="n">variation</span>
<span class="kn">from</span> <span class="nn">dispel.utils</span> <span class="kn">import</span> <span class="n">to_camel_case</span>

<span class="n">TASK_NAME</span> <span class="o">=</span> <span class="n">AV</span><span class="p">(</span><span class="s2">&quot;Grip Force test&quot;</span><span class="p">,</span> <span class="s2">&quot;GRIP&quot;</span><span class="p">)</span>

<span class="n">TEST_DURATION_VALIDATOR</span> <span class="o">=</span> <span class="n">RangeValidator</span><span class="p">(</span><span class="n">lower_bound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span>

<span class="n">CategoryToDiff</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;CategoryToDiff&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;category_1&quot;</span><span class="p">,</span> <span class="s2">&quot;category_2&quot;</span><span class="p">])</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Tuple-like object with the two pressure categories used to compute mean</span>
<span class="sd">applied force difference.&quot;&quot;&quot;</span>

<span class="c1"># Plateau detection algorithm constants</span>
<span class="n">N_SEQUENCE</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">SMALL_GAP_SIZE</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">MOVING_AVG_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">LOOK_BEHIND</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">LOOK_AHEAD</span> <span class="o">=</span> <span class="mi">40</span>


<div class="viewcode-block" id="PlateauModality">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.PlateauModality">[docs]</a>
<span class="k">class</span> <span class="nc">PlateauModality</span><span class="p">(</span><span class="n">AVEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerated constant representing the plateau modality.</span>

<span class="sd">    This modality defines the subpart of the plateau that is kept</span>
<span class="sd">    for measure computation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">abbr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_offset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_offset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">end_offset</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">abbr</span><span class="p">)</span>

    <span class="n">MIDDLE_FOUR</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;four seconds in the middle&quot;</span><span class="p">,</span> <span class="s2">&quot;s4m&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">MIDDLE_TWO</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;two seconds in the middle&quot;</span><span class="p">,</span> <span class="s2">&quot;s2m&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">LAST_FIVE</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;last five seconds&quot;</span><span class="p">,</span> <span class="s2">&quot;s5l&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="TargetPressureModality">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TargetPressureModality">[docs]</a>
<span class="k">class</span> <span class="nc">TargetPressureModality</span><span class="p">(</span><span class="n">AVEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerated constant representing the pressure modalities.&quot;&quot;&quot;</span>

    <span class="n">LOW</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;low target pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">)</span>
    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;medium target pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;high target pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
    <span class="n">VERY_HIGH</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;very high target pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;very_high&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="PositionModality">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.PositionModality">[docs]</a>
<span class="k">class</span> <span class="nc">PositionModality</span><span class="p">(</span><span class="n">AVEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Screen thumb position for grip force task.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a camel case string of position modalities.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">to_camel_case</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x thumb position&quot;</span><span class="p">,</span> <span class="s2">&quot;xpos&quot;</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y thumb position&quot;</span><span class="p">,</span> <span class="s2">&quot;ypos&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="smooth_discrete_pdf">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.smooth_discrete_pdf">[docs]</a>
<span class="k">def</span> <span class="nf">smooth_discrete_pdf</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the discrete probability density function (PDF).</span>

<span class="sd">    Then smooth the values by filtering out small spikes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A series of a signal. e.g. &#39;pressure&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A series of the discrete derivative of the signal where small</span>
<span class="sd">        spikes have been smoothed.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raises a value error if the pandas.Series is too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The pd.series is too short to be smoothed.&quot;</span> <span class="sa">f</span><span class="s2">&quot;data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="avg_diff_discrete_pdf">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.avg_diff_discrete_pdf">[docs]</a>
<span class="k">def</span> <span class="nf">avg_diff_discrete_pdf</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the average of the differentiated discrete PDF.</span>

<span class="sd">    This corresponds to the average of the second discrete</span>
<span class="sd">    derivative of the pressure signal. In the process of computing the</span>
<span class="sd">    metric, we add several columns, namely &#39;discrete-pdf&#39;, &#39;diff-discrete-pdf&#39;</span>
<span class="sd">    and `level-sequence` where we set the contextual level information</span>
<span class="sd">    under a series format with integers going from 0 to 7 indicating</span>
<span class="sd">    which level we are in.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        The two columns &#39;discrete-pdf&#39; and &#39;pressure&#39; of the data frame</span>
<span class="sd">        obtained by concatenating the levels.</span>
<span class="sd">    context</span>
<span class="sd">        The merged context obtained from the concatenation of the</span>
<span class="sd">        levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A new data frame with `discrete-pdf`, `diff-discrete-pdf`,</span>
<span class="sd">        `avg-diff-discrete-pdf` and `level-sequence` columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># smoothing the discrete pdf</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;discrete-pdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_discrete_pdf</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">])</span>

    <span class="c1"># differentiate the discrete_pdf</span>
    <span class="n">diff_discrete_pdf</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;discrete-pdf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">diff_discrete_pdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;diff-discrete-pdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_discrete_pdf</span>

    <span class="c1"># init avg_diff_discrete_pdf</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># goes through the eighth different levels</span>
    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_raw_value</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level_</span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_discrete_pdf</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">level</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">diff_discrete_pdf</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">level</span><span class="o">.</span><span class="n">end</span>
        <span class="p">)</span>
        <span class="c1"># copy the label</span>
        <span class="n">output</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="c1"># compute the mean for each level</span>
        <span class="n">pressure_level</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;diff-discrete-pdf&quot;</span><span class="p">]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressure_level</span><span class="p">))</span>

    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="get_target_pressure">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.get_target_pressure">[docs]</a>
<span class="k">def</span> <span class="nf">get_target_pressure</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get target pressure from context and level sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    context</span>
<span class="sd">        The merged context obtained from the concatenation of the</span>
<span class="sd">        levels.</span>
<span class="sd">    seq</span>
<span class="sd">        The sequence of interest: e.g. a value in {0,1,..,7}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Target pressure corresponding to the sequence seq.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">get_raw_value</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;targetPressure_</span><span class="si">{</span><span class="n">seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_second_derivative_spikes">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.compute_second_derivative_spikes">[docs]</a>
<span class="k">def</span> <span class="nf">compute_second_derivative_spikes</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find spikes in diff discrete pdf.</span>

<span class="sd">    The method is simple, we compare the moving average of the second</span>
<span class="sd">    derivative of the pressure signal (diff discrete pdf) to the</span>
<span class="sd">    average of the latter on the entire level-sequence. A spike or a</span>
<span class="sd">    plateau is detected if the moving average is higher than the</span>
<span class="sd">    level mean.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A data frame with the two columns &#39;diff-discrete-pdf&#39; and</span>
<span class="sd">        &#39;avg-diff-discrete-pdf&#39; (e.g.: obtained with avg_diff_discrete_pdf).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A series with values in {0, 1} indicating if a plateau has been</span>
<span class="sd">        detected.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        A value error is raised if the length of the data is too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Length of the data is too short. len(data) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;is less than 20&quot;</span>
        <span class="p">)</span>
    <span class="c1"># initialize the detected-plateau</span>
    <span class="n">detected_plateau</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;diff-discrete-pdf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MOVING_AVG_SIZE</span><span class="p">])</span>
            <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">detected_plateau</span></div>



<div class="viewcode-block" id="fill_plateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.fill_plateau">[docs]</a>
<span class="k">def</span> <span class="nf">fill_plateau</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill small gaps in the plateau.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A series of values in {0, 1} typically the one obtained after applying</span>
<span class="sd">        the `compute_second_derivative_spikes` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A modified version of the series where small gaps in the plateau have</span>
<span class="sd">        been filled.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        A value error is raised if the length of the data is too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Length of the data is too short.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;len(data) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> is less than 20&quot;</span>
        <span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">SMALL_GAP_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">SMALL_GAP_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="remove_short_plateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.remove_short_plateau">[docs]</a>
<span class="k">def</span> <span class="nf">remove_short_plateau</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">plateau_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove plateau shorter than plateau_size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A series of values in {0, 1}, typically the one obtained after applying</span>
<span class="sd">        the `fill_plateau` function.</span>
<span class="sd">    plateau_size</span>
<span class="sd">        The minimum size of a plateau, by default 30</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A modified version of the series where plateau shorter than</span>
<span class="sd">        the threshold plateau_size have been removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">plateau_size</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">count</span> <span class="p">:</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="extend_and_convert_plateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.extend_and_convert_plateau">[docs]</a>
<span class="k">def</span> <span class="nf">extend_and_convert_plateau</span><span class="p">(</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">detected_plateau</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extend the plateau under certain conditions.</span>

<span class="sd">    The main idea is to fill large gaps between a current index and</span>
<span class="sd">    a lookahead index where a plateau is detected. Gaps are filled whenever the</span>
<span class="sd">    lookahead mean (defined as the mean between the current index and the</span>
<span class="sd">    lookahead) does not differ too much (0.5 pressure unit)</span>
<span class="sd">    from a `lookbehind` mean (defined as the mean from a lookbehind index until</span>
<span class="sd">    the current index</span>
<span class="sd">    ).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pressure</span>
<span class="sd">        A Series of &#39;pressure&#39;</span>
<span class="sd">    detected_plateau</span>
<span class="sd">        A series of detected plateau</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        The updated series &#39;detected-plateau&#39; where large gaps have been filled</span>
<span class="sd">        and then where &#39;1&#39; have been replaced with values from the &#39;pressure&#39;</span>
<span class="sd">        column.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        A value error is raised if the length of the data is too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LOOK_AHEAD</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Length of the data is too short.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;len(pressure) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span><span class="si">}</span><span class="s2"> is less than 20&quot;</span>
        <span class="p">)</span>

    <span class="n">detected_plateau</span> <span class="o">=</span> <span class="n">detected_plateau</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LOOK_AHEAD</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span> <span class="o">-</span> <span class="n">LOOK_AHEAD</span><span class="p">):</span>
        <span class="c1"># compute the look behind mean</span>
        <span class="n">rolling_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">LOOK_BEHIND</span><span class="p">))</span> <span class="p">:</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># compute the look ahead mean</span>
        <span class="n">mean_forward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">LOOK_AHEAD</span><span class="p">])</span>
        <span class="c1"># check the three conditions</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">LOOK_AHEAD</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_forward</span> <span class="o">-</span> <span class="n">rolling_mean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">LOOK_AHEAD</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">LOOK_AHEAD</span>
            <span class="p">]</span>

        <span class="c1"># finish setting the pressure value</span>
        <span class="k">if</span> <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LOOK_AHEAD</span><span class="p">):</span>
        <span class="c1"># finish setting the pressure value</span>
        <span class="k">if</span> <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">detected_plateau</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">detected_plateau</span></div>



<div class="viewcode-block" id="refined_target">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.refined_target">[docs]</a>
<span class="k">def</span> <span class="nf">refined_target</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">contexts</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refine the target pressure for the detected plateau.</span>

<span class="sd">    The method is simple, on each detected plateau, we take</span>
<span class="sd">    the maximum occurring target sequence as `the label` and add</span>
<span class="sd">    the refined target as the value of the target pressure for this</span>
<span class="sd">    label (or level sequence).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A dataframe with the columns {&#39;detected-plateau&#39;, &#39;level-sequence&#39;}</span>
<span class="sd">    contexts</span>
<span class="sd">        The merged context obtained from the concatenation of the</span>
<span class="sd">        levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        The series &#39;refined-target&#39; corresponding to the target pressure</span>
<span class="sd">        extended to the size of the &#39;detected-plateau&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset_plateau</span> <span class="o">=</span> <span class="n">index</span>
            <span class="k">while</span> <span class="p">(</span>
                <span class="n">offset_plateau</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">offset_plateau</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">offset_plateau</span> <span class="o">=</span> <span class="n">offset_plateau</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">maximum_occurring_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">offset_plateau</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

            <span class="n">target</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">offset_plateau</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_target_pressure</span><span class="p">(</span>
                <span class="n">contexts</span><span class="p">,</span> <span class="n">maximum_occurring_sequence</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">offset_plateau</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">target</span></div>



<div class="viewcode-block" id="FilterIncompleteSequences">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterIncompleteSequences">[docs]</a>
<span class="k">class</span> <span class="nc">FilterIncompleteSequences</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A filter to skip levels that do not contain eight sequences.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The filter expects concatenated levels from</span>
<span class="sd">    :class:`~dispel.processing.transform.ConcatenateLevels` and should contain the</span>
<span class="sd">    target pressure values in the context (i.e. ``targetPressure_{index}``.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterIncompleteSequences.filter">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterIncompleteSequences.filter">[docs]</a>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Level</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Level</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if there is contextual info for the eight sequences.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
            <span class="n">good</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span><span class="p">):</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;targetPressure_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">good</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="FilterIncompleteSequences.repr">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterIncompleteSequences.repr">[docs]</a>
    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get representation of the filter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;filter incomplete levels&quot;</span></div>
</div>



<span class="n">FILTER_INCOMPLETE_SEQUENCES</span> <span class="o">=</span> <span class="n">FilterIncompleteSequences</span><span class="p">()</span>


<div class="viewcode-block" id="compute_plateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.compute_plateau">[docs]</a>
<span class="k">def</span> <span class="nf">compute_plateau</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the plateau.</span>

<span class="sd">    To compute the plateau we follow several steps:</span>
<span class="sd">    The first step is to compute the first and second discrete</span>
<span class="sd">    derivative of the resampled and interpolated pressure signal.</span>
<span class="sd">    (see :func:`avg_diff_discrete_pdf`).</span>

<span class="sd">    Then we initialize our plateau detection algorithm by finding the</span>
<span class="sd">    spikes in the second discrete derivative of the signal (see</span>
<span class="sd">    :func:`compute_second_derivative_spikes`).</span>

<span class="sd">    A third step consists in filling all small gaps in the detected</span>
<span class="sd">    plateau. (see :func:`fill_plateau`).</span>

<span class="sd">    Once plateau are filled we filter the result by removing the very</span>
<span class="sd">    short detected plateau (see :func:`remove_short_plateau`).</span>

<span class="sd">    The next step consists in extending the plateau filling large</span>
<span class="sd">    gap under certain conditions. (see</span>
<span class="sd">    :func:`extend_and_convert_plateau`).</span>

<span class="sd">    Finally we create a target pressure signal based on the identified</span>
<span class="sd">    plateau. The idea is that a plateau often goes beyond the level</span>
<span class="sd">    border and hence should not be compared to the target pressure</span>
<span class="sd">    of the next level but on the main one on which the plateau resides.</span>
<span class="sd">    (see :func:`refined_target`).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        The data on which the plateau computation is to be performed.</span>
<span class="sd">    level</span>
<span class="sd">        The level corresponding to the given data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The pandas data frame containing the different plateaus.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute average diff discrete pdf</span>
    <span class="n">plateau_df</span> <span class="o">=</span> <span class="n">avg_diff_discrete_pdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="c1"># first step of plateau detection</span>
    <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_second_derivative_spikes</span><span class="p">(</span>
        <span class="n">plateau_df</span><span class="p">[[</span><span class="s2">&quot;diff-discrete-pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Fill small gaps in the plateau</span>
    <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_plateau</span><span class="p">(</span><span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">])</span>

    <span class="c1"># remove all the short plateau</span>
    <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_short_plateau</span><span class="p">(</span>
        <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># extend and convert the plateau to the pressure value</span>
    <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_and_convert_plateau</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">],</span> <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># refine the plateau and define the target accordingly</span>
    <span class="n">plateau_df</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refined_target</span><span class="p">(</span>
        <span class="n">plateau_df</span><span class="p">[[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;level-sequence&quot;</span><span class="p">]],</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">plateau_df</span></div>



<div class="viewcode-block" id="TransformPlateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformPlateau">[docs]</a>
<span class="k">class</span> <span class="nc">TransformPlateau</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An transform processing step for plateau detection.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformPlateau.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformPlateau.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;screen_ts_resampled&quot;</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">compute_plateau</span><span class="p">,</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="s2">&quot;plateau&quot;</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;discrete-pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;Discrete PDF&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span>
                    <span class="s2">&quot;diff-discrete-pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;Differentiated discrete PDF&quot;</span>
                <span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span>
                    <span class="s2">&quot;avg-diff-discrete-pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;Average differentiated discrete PDF&quot;</span>
                <span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;Detected plateau&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;Level Sequence&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;refined-target&quot;</span><span class="p">,</span> <span class="s2">&quot;Refined Target&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="time_defined_plateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.time_defined_plateau">[docs]</a>
<span class="k">def</span> <span class="nf">time_defined_plateau</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">,</span> <span class="n">plateau</span><span class="p">:</span> <span class="n">PlateauModality</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract time-defined plateau.</span>

<span class="sd">    This function extracts the plateaus as defined in the plateau modality.</span>
<span class="sd">    More formally, given a level that is defined by the following time</span>
<span class="sd">    windows: [start: end]. The plateau offset refines this time windows</span>
<span class="sd">    only keeping the section</span>
<span class="sd">    ``[start + plateau.start_offset: end - plateau.end_offset]``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A data frame such as the one obtained after resampling screen.</span>
<span class="sd">        e.g.: `screen_ts_resampled`</span>
<span class="sd">    level</span>
<span class="sd">        Any Level</span>
<span class="sd">    plateau</span>
<span class="sd">        A plateau modality defining the time windows on which measures</span>
<span class="sd">        will be computed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A data frame with three columns: ``detected-plateau`` is equals to</span>
<span class="sd">        the pressure on the plateau zero otherwise.</span>
<span class="sd">        ``level-sequence`` are integers indicating the level.</span>
<span class="sd">        ``refined-target`` is the target value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># goes through the eighth different levels</span>
    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">contexts</span><span class="o">.</span><span class="n">get_raw_value</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level_</span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">level</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">plateau</span><span class="o">.</span><span class="n">start_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">level</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">plateau</span><span class="o">.</span><span class="n">end_offset</span>
        <span class="p">)</span>

        <span class="c1"># copy the label</span>
        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">]</span>

    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># define the target</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_target_pressure</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">[[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;level-sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">]]</span></div>



<div class="viewcode-block" id="TransformTimeDefinedPlateau">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformTimeDefinedPlateau">[docs]</a>
<span class="k">class</span> <span class="nc">TransformTimeDefinedPlateau</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An transform processing step for time-defined plateau.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformTimeDefinedPlateau.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformTimeDefinedPlateau.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="p">:</span> <span class="n">PlateauModality</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;screen_ts_resampled&quot;</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">time_defined_plateau</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">plateau</span><span class="p">),</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;plateau_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;detected-plateau&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;Level Sequence&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;refined-target&quot;</span><span class="p">,</span> <span class="s2">&quot;Refined Target&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TransformPressureError">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformPressureError">[docs]</a>
<span class="k">class</span> <span class="nc">TransformPressureError</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A TransformStep for pressure error related measures.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformPressureError.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformPressureError.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PlateauModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_pressure_error</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">]</span>

        <span class="n">data_set_id</span> <span class="o">=</span> <span class="s2">&quot;plateau&quot;</span>
        <span class="n">new_data_set_id</span> <span class="o">=</span> <span class="s2">&quot;pressure-error&quot;</span>

        <span class="k">if</span> <span class="n">plateau</span><span class="p">:</span>
            <span class="n">data_set_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_set_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_data_set_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_data_set_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data_set_id</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">_pressure_error</span><span class="p">,</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="n">new_data_set_id</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span><span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;pressure-error&quot;</span><span class="p">,</span> <span class="s2">&quot;Pressure Error&quot;</span><span class="p">)],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="target_pressure_to_category">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.target_pressure_to_category">[docs]</a>
<span class="k">def</span> <span class="nf">target_pressure_to_category</span><span class="p">(</span>
    <span class="n">contexts</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">TargetPressureModality</span><span class="p">],</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mapping between target pressure and their level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    contexts</span>
<span class="sd">        The merged context obtained from the concatenation of the</span>
<span class="sd">        levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[Dict[Any, str], List]</span>
<span class="sd">        The first element is a dictionary with as keys, the values of</span>
<span class="sd">        the four different target pressure and as values, the pressure category</span>
<span class="sd">        i.e values are in `{&#39;low&#39;, &#39;medium&#39;, &#39;high&#39;, &#39;very_high&#39;}`.</span>
<span class="sd">        The Second element is the sequence of pressure category e.g.:</span>
<span class="sd">        `[&#39;low&#39;, &#39;high&#39;, &#39;very_high&#39;, &#39;medium&#39;, &#39;high&#39;, &#39;medium&#39;,</span>
<span class="sd">        &#39;very_high&#39;,&#39;low&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_pressure</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_target_pressure</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span><span class="p">)]</span>
    <span class="n">four_target</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">target_pressure</span><span class="p">)))</span>
    <span class="n">target_to_cat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">four_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
        <span class="n">four_target</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
        <span class="n">four_target</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
        <span class="n">four_target</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">VERY_HIGH</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">target_to_cat</span><span class="p">,</span> <span class="p">[</span><span class="n">target_to_cat</span><span class="p">[</span><span class="n">pressure</span><span class="p">]</span> <span class="k">for</span> <span class="n">pressure</span> <span class="ow">in</span> <span class="n">target_pressure</span><span class="p">])</span></div>



<div class="viewcode-block" id="TransformRefinedTargetCategory">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformRefinedTargetCategory">[docs]</a>
<span class="k">class</span> <span class="nc">TransformRefinedTargetCategory</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A TransformStep for to identify pressure categories.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformRefinedTargetCategory.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformRefinedTargetCategory.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PlateauModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">target_to_category</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Map refined-target column to a target pressure category.&quot;&quot;&quot;</span>
            <span class="n">mapping</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">target_pressure_to_category</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

        <span class="n">data_set_id</span> <span class="o">=</span> <span class="s2">&quot;plateau&quot;</span>
        <span class="n">new_data_set_id</span> <span class="o">=</span> <span class="s2">&quot;pressure-category&quot;</span>

        <span class="k">if</span> <span class="n">plateau</span><span class="p">:</span>
            <span class="n">data_set_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_set_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_data_set_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_data_set_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data_set_id</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">target_to_category</span><span class="p">,</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="n">new_data_set_id</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;pressure-category&quot;</span><span class="p">,</span> <span class="s2">&quot;Pressure category&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="filter_category">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.filter_category">[docs]</a>
<span class="k">def</span> <span class="nf">filter_category</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">cat_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter data based on category.</span>

<span class="sd">    The data frame data is filtered to only keep values for which the</span>
<span class="sd">    `&#39;pressure-category&#39;` is equal to the `cat_str`. The exception is</span>
<span class="sd">    when `cat_str == &#39;all&#39;` where data is returned without filtering.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        A dataframe typically obtained after applying the TransformStep :</span>
<span class="sd">        :class:`TransformPlateau`.</span>
<span class="sd">    category</span>
<span class="sd">        A dataframe with column ``&#39;pressure-category&#39;`` typically obtained</span>
<span class="sd">        after applying the TransformStep :</span>
<span class="sd">        :class: `TransformRefinedTargetCategory.`</span>
<span class="sd">    cat_str</span>
<span class="sd">        The pressure category indicating on which</span>
<span class="sd">        category the applied force is selected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The filtered version of the data frame data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cat_str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">category</span><span class="p">[</span><span class="s2">&quot;pressure-category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cat_str</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>



<div class="viewcode-block" id="rms_pressure_error">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.rms_pressure_error">[docs]</a>
<span class="k">def</span> <span class="nf">rms_pressure_error</span><span class="p">(</span>
    <span class="n">pressure_error</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">only_category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the Root Mean Square of `&#39;pressure-error&#39;` column.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pressure_error</span>
<span class="sd">        A dataframe with column `&#39;pressure-error&#39;` typically obtained after</span>
<span class="sd">        applying the TransformStep : :class:`TransformPressureError`.</span>
<span class="sd">    category</span>
<span class="sd">        A dataframe with column `&#39;pressure-category&#39;` typically obtained after</span>
<span class="sd">        applying the TransformStep : :class:`TransformRefinedTargetCategory`.</span>
<span class="sd">    only_category</span>
<span class="sd">        The pressure category indicating on which</span>
<span class="sd">        category the RMSE is computed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The Root Mean Square of the `&#39;pressure-error&#39;` column on the defined</span>
<span class="sd">        pressure category cat str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">filter_category</span><span class="p">(</span><span class="n">pressure_error</span><span class="p">[</span><span class="s2">&quot;pressure-error&quot;</span><span class="p">],</span> <span class="n">category</span><span class="p">,</span> <span class="n">only_category</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span></div>



<span class="k">def</span> <span class="nf">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">-all&quot;</span>


<div class="viewcode-block" id="ExtractRMSPressure">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractRMSPressure">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractRMSPressure</span><span class="p">(</span><span class="n">ExtractStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for pressure accuracy measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test</span>
<span class="sd">    category</span>
<span class="sd">        The pressure category indicating on which category the RMSE is</span>
<span class="sd">        computed.</span>
<span class="sd">    plateau</span>
<span class="sd">        The plateau on which the extraction is to be performed</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractRMSPressure.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractRMSPressure.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">,</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plateau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PlateauModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">modalities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AV</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The measure of the distance between the ideal &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target force and the actual force applied by the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;subject for the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pressure-error&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure-category&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">modalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">av</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> target force category&quot;</span>
        <span class="k">if</span> <span class="n">plateau</span><span class="p">:</span>
            <span class="n">modalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and the plateau modality </span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">data_set_ids</span><span class="p">]</span>
        <span class="n">description</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="n">modalities</span><span class="p">,</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;root mean square error&quot;</span><span class="p">,</span> <span class="s2">&quot;RMSE&quot;</span><span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data_set_ids</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">rms_pressure_error</span><span class="p">,</span> <span class="n">only_category</span><span class="o">=</span><span class="n">category</span>
            <span class="p">),</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="applied_force">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.applied_force">[docs]</a>
<span class="k">def</span> <span class="nf">applied_force</span><span class="p">(</span>
    <span class="n">detected_plateau</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">cat_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select the applied force or partial &#39;detected-plateau&#39; column.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    detected_plateau</span>
<span class="sd">        A dataframe with column &#39;detected-plateau&#39; typically obtained after</span>
<span class="sd">        applying the TransformStep : :class:`TransformPlateau`.</span>
<span class="sd">    category</span>
<span class="sd">        A dataframe with column ``&#39;pressure-category&#39;`` typically obtained</span>
<span class="sd">        after applying the TransformStep :</span>
<span class="sd">        :class: `TransformRefinedTargetCategory.`</span>
<span class="sd">    cat_str</span>
<span class="sd">        The pressure category indicating on which</span>
<span class="sd">        category the applied force is selected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        The applied force or the &#39;detected-plateau&#39; column on the defined</span>
<span class="sd">        pressure category cat_str.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">non_null</span> <span class="o">=</span> <span class="n">detected_plateau</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">filter_category</span><span class="p">(</span><span class="n">detected_plateau</span><span class="p">[</span><span class="n">non_null</span><span class="p">],</span> <span class="n">category</span><span class="p">,</span> <span class="n">cat_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;detected-plateau&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;refined-target&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="ExtractAppliedForceStats">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractAppliedForceStats">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractAppliedForceStats</span><span class="p">(</span><span class="n">ExtractMultipleStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for applied force measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test.</span>
<span class="sd">    category</span>
<span class="sd">        The pressure category indicating on which category the applied force</span>
<span class="sd">        stats are computed.</span>
<span class="sd">    plateau</span>
<span class="sd">        The plateau on which the extraction is to be performed.</span>
<span class="sd">    percentile</span>
<span class="sd">        Compute the q-th percentile of the applied forces in the</span>
<span class="sd">        aggregation methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractAppliedForceStats.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractAppliedForceStats.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">,</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plateau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PlateauModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">percentile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">def</span> <span class="nf">_function_factory</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">agg_label</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">applied_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg</span><span class="p">),</span>
                <span class="n">aggregation</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="n">agg_label</span><span class="p">,</span> <span class="n">agg</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_function_factory</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">agg_label</span><span class="p">)</span> <span class="k">for</span> <span class="n">agg</span><span class="p">,</span> <span class="n">agg_label</span> <span class="ow">in</span> <span class="n">DEFAULT_AGGREGATIONS</span>
        <span class="p">]</span>
        <span class="n">functions</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">variation</span><span class="p">(</span><span class="n">applied_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">category</span><span class="p">)),</span>
                <span class="n">aggregation</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;coefficient of variation&quot;</span><span class="p">,</span> <span class="s2">&quot;CV&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">functions</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                    <span class="n">applied_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">category</span><span class="p">),</span> <span class="n">percentile</span>
                <span class="p">),</span>
                <span class="n">aggregation</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">-th percentile&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">th&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">modalities</span> <span class="o">=</span> <span class="p">[</span><span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The applied force is a normalized version of the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pressure, measured on plateaus for the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">, by &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;the target pressure on the same plateau.&quot;</span>
        <span class="p">)</span>
        <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure-category&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">modalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">av</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> target pressure category.&quot;</span>
        <span class="k">if</span> <span class="n">plateau</span><span class="p">:</span>
            <span class="n">modalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; the plateau modality </span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;plateau&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure-category&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="n">description</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;applied force&quot;</span><span class="p">,</span> <span class="s2">&quot;applied_force&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="n">modalities</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data_set_ids</span><span class="p">,</span>
            <span class="n">functions</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExtractMeanAppliedForceDiff">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractMeanAppliedForceDiff">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractMeanAppliedForceDiff</span><span class="p">(</span><span class="n">ExtractMultipleStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for mean applied force difference (MAF).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test.</span>
<span class="sd">    categories_to_diff</span>
<span class="sd">        The :class:`NamedTuple` CategoryToDiff containing the two pressure</span>
<span class="sd">        categories on which the MAF difference is compute.</span>
<span class="sd">    plateau</span>
<span class="sd">        The plateau on which the extraction is to be performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractMeanAppliedForceDiff.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractMeanAppliedForceDiff.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">,</span>
        <span class="n">categories_to_diff</span><span class="p">:</span> <span class="n">CategoryToDiff</span><span class="p">,</span>
        <span class="n">plateau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PlateauModality</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">def</span> <span class="nf">_mean_maf_diff</span><span class="p">(</span>
            <span class="n">detected_plateau</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">category</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">categories_to_diff</span><span class="p">:</span> <span class="n">CategoryToDiff</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">mean_maf_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">applied_force</span><span class="p">(</span><span class="n">detected_plateau</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mean_maf_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">applied_force</span><span class="p">(</span><span class="n">detected_plateau</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_maf_1</span> <span class="o">-</span> <span class="n">mean_maf_2</span><span class="p">)</span>

        <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">_mean_maf_diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categories_to_diff</span><span class="p">))]</span>

        <span class="n">modalities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">,</span>
            <span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_1</span><span class="o">.</span><span class="n">av</span><span class="p">,</span>
            <span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_2</span><span class="o">.</span><span class="n">av</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Absolute difference between the mean applied force &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(pressure normalized by the Target Force) on the&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_1</span><span class="si">}</span><span class="s2"> and the mean &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;applied force on the </span><span class="si">{</span><span class="n">categories_to_diff</span><span class="o">.</span><span class="n">category_2</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; for the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure-category&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">plateau</span><span class="p">:</span>
            <span class="n">modalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plateau</span><span class="o">.</span><span class="n">av</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; the plateau modality </span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data_set_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;plateau&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure-category&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">plateau</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="n">description</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;MAF difference&quot;</span><span class="p">,</span> <span class="s2">&quot;maf_diff&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="n">modalities</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data_set_ids</span><span class="p">,</span>
            <span class="n">functions</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExtractThumbPositionVariation">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractThumbPositionVariation">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractThumbPositionVariation</span><span class="p">(</span><span class="n">ExtractMultipleStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for thumb position on screen.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractThumbPositionVariation.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractThumbPositionVariation.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_thumb_variation</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="n">PositionModality</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">variation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="o">.</span><span class="n">column</span><span class="p">]),</span>
                <span class="n">modalities</span><span class="o">=</span><span class="p">[</span><span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">av</span><span class="p">],</span>
                <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;coefficient of variation&quot;</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The coefficient of variation of the </span><span class="si">{position}</span><span class="s2"> for &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">GREATER_THAN_ZERO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
            <span class="n">transform_functions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_thumb_variation</span><span class="p">,</span> <span class="n">PositionModality</span><span class="p">)),</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="reaction_time_between_level">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.reaction_time_between_level">[docs]</a>
<span class="k">def</span> <span class="nf">reaction_time_between_level</span><span class="p">(</span><span class="n">plateau</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the reaction time between the 8 different levels.&quot;&quot;&quot;</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span>
    <span class="n">reaction_time</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">transition_time</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">transition_start</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">transition_end</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_category</span> <span class="o">=</span> <span class="n">target_pressure_to_category</span><span class="p">(</span><span class="n">contexts</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="n">transition_cat</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">pressure_category</span><span class="p">[</span><span class="n">it</span> <span class="p">:</span> <span class="n">it</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># find the current level</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">plateau</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seq</span>

        <span class="c1"># find the next level</span>
        <span class="n">mask_next</span> <span class="o">=</span> <span class="n">plateau</span><span class="p">[</span><span class="s2">&quot;level-sequence&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seq</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># identify the end of the level</span>
        <span class="n">end_level</span> <span class="o">=</span> <span class="n">plateau</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># identify the current level target</span>
        <span class="n">curr_level</span> <span class="o">=</span> <span class="n">plateau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># identify the end of the next level</span>
        <span class="n">end_next_level</span> <span class="o">=</span> <span class="n">plateau</span><span class="p">[</span><span class="n">mask_next</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># search for a change in refined-target</span>
        <span class="n">mask_plateau</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">plateau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_level</span><span class="p">:</span><span class="n">end_next_level</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">curr_level</span>
        <span class="p">)</span>

        <span class="c1"># find the end of the plateau</span>
        <span class="n">in_between</span> <span class="o">=</span> <span class="n">plateau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_level</span><span class="p">:</span><span class="n">end_next_level</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">][</span>
            <span class="n">mask_plateau</span>
        <span class="p">]</span>
        <span class="n">end_plateau</span> <span class="o">=</span> <span class="n">in_between</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_between</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">end_level</span>

        <span class="c1"># add the reaction time</span>
        <span class="n">reaction_time</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_plateau</span> <span class="o">-</span> <span class="n">end_level</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># transition time</span>
        <span class="c1"># find the start of the next plateau</span>
        <span class="n">till_next_level_end</span> <span class="o">=</span> <span class="n">plateau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_plateau</span><span class="p">:</span><span class="n">end_next_level</span><span class="p">,</span> <span class="s2">&quot;refined-target&quot;</span><span class="p">]</span>
        <span class="n">next_plateau</span> <span class="o">=</span> <span class="n">till_next_level_end</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">end_transition</span> <span class="o">=</span> <span class="n">till_next_level_end</span><span class="p">[</span><span class="n">next_plateau</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">transition_time</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_transition</span> <span class="o">-</span> <span class="n">end_plateau</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">transition_end</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_transition</span>
        <span class="n">transition_start</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_plateau</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;reaction-time&quot;</span><span class="p">:</span> <span class="n">reaction_time</span><span class="p">,</span>
            <span class="s2">&quot;transition-time&quot;</span><span class="p">:</span> <span class="n">transition_time</span><span class="p">,</span>
            <span class="s2">&quot;transition-start&quot;</span><span class="p">:</span> <span class="n">transition_start</span><span class="p">,</span>
            <span class="s2">&quot;transition-end&quot;</span><span class="p">:</span> <span class="n">transition_end</span><span class="p">,</span>
            <span class="s2">&quot;transition-category&quot;</span><span class="p">:</span> <span class="n">transition_cat</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="TransformTimeRelatedInfo">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformTimeRelatedInfo">[docs]</a>
<span class="k">class</span> <span class="nc">TransformTimeRelatedInfo</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for Time related measures.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformTimeRelatedInfo.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformTimeRelatedInfo.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;plateau&quot;</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">reaction_time_between_level</span><span class="p">,</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="s2">&quot;time-info&quot;</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;reaction-time&quot;</span><span class="p">,</span> <span class="s2">&quot;Reaction time&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span>
                    <span class="s2">&quot;transition-time&quot;</span><span class="p">,</span> <span class="s2">&quot;Transition Time between two plateaus.&quot;</span>
                <span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;transition-category&quot;</span><span class="p">,</span> <span class="s2">&quot;Transition category&quot;</span><span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span>
                    <span class="s2">&quot;transition-start&quot;</span><span class="p">,</span> <span class="s2">&quot;Start time of each transition&quot;</span>
                <span class="p">),</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;transition-end&quot;</span><span class="p">,</span> <span class="s2">&quot;End time of each transition&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExtractReactionTimeStats">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractReactionTimeStats">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractReactionTimeStats</span><span class="p">(</span><span class="n">AggregateRawDataSetColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for Reaction Time measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractReactionTimeStats.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractReactionTimeStats.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;reaction time&quot;</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="p">[</span><span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="se">{{</span><span class="s2">aggregation</span><span class="se">}}</span><span class="s2"> time taken to initiate force &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;adaptation when the new force target level is &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;displayed for the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2"> hand.&quot;</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">TEST_DURATION_VALIDATOR</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;time-info&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reaction-time&quot;</span><span class="p">,</span>
            <span class="n">aggregations</span><span class="o">=</span><span class="n">DEFAULT_AGGREGATIONS</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="FilterTransition">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterTransition">[docs]</a>
<span class="k">class</span> <span class="nc">FilterTransition</span><span class="p">(</span><span class="n">FilterIncompleteSequences</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter incomplete sequences or level without the selected transition.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterTransition.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterTransition.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">from_pressure</span><span class="p">:</span> <span class="n">TargetPressureModality</span><span class="p">,</span> <span class="n">to_pressure</span><span class="p">:</span> <span class="n">TargetPressureModality</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_pressure</span> <span class="o">=</span> <span class="n">from_pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_pressure</span> <span class="o">=</span> <span class="n">to_pressure</span></div>


<div class="viewcode-block" id="FilterTransition.repr">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterTransition.repr">[docs]</a>
    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get representation of the filter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;filter complete sequences from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">from_pressure</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_pressure</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FilterTransition.filter">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.FilterTransition.filter">[docs]</a>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Level</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Level</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter for transitions.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">from_pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pressure</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">target_state</span> <span class="o">=</span> <span class="n">target_pressure_to_category</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">transition</span> <span class="o">==</span> <span class="n">target_state</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="compute_transition">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.compute_transition">[docs]</a>
<span class="k">def</span> <span class="nf">compute_transition</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">transition</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">,</span> <span class="n">TargetPressureModality</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find all the transitions time of the selected transition.&quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;transition-category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">transition</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;transition-time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>



<div class="viewcode-block" id="ExtractTransitionTime">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractTransitionTime">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractTransitionTime</span><span class="p">(</span><span class="n">ExtractStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for Transition Time measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand used to perform the test</span>
<span class="sd">    transition</span>
<span class="sd">        A tuple indicating the two plateaus defining a transition. e.g.:</span>
<span class="sd">        {&#39;low&#39;,&#39;high&#39;} indicates a transition from the ``&#39;low&#39;`` plateau to the</span>
<span class="sd">        ``&#39;high&#39;`` plateau.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractTransitionTime.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractTransitionTime.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">,</span>
        <span class="n">transition</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TargetPressureModality</span><span class="p">,</span> <span class="n">TargetPressureModality</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">cat_from</span><span class="p">,</span> <span class="n">cat_to</span> <span class="o">=</span> <span class="n">transition</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span><span class="s2">&quot;transition time&quot;</span><span class="p">,</span> <span class="s2">&quot;tt&quot;</span><span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="p">[</span>
                <span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">,</span>
                <span class="n">AV</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">cat_from</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">cat_to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cat_from</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">cat_to</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The mean time taken to adjust the exerted force to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;the next force target level from </span><span class="si">{</span><span class="n">cat_from</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cat_to</span><span class="si">}</span><span class="s2"> for the </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">. It is calculated as the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;time elapsed between the end of one plateau to the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;beginning of the next one.&quot;</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">TEST_DURATION_VALIDATOR</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;time-info&quot;</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">compute_transition</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="n">transition</span>
            <span class="p">),</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">_hand_to_level_id</span><span class="p">(</span><span class="n">hand</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="n">FilterTransition</span><span class="p">(</span><span class="o">*</span><span class="n">transition</span><span class="p">),</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="compute_overshoot">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.compute_overshoot">[docs]</a>
<span class="k">def</span> <span class="nf">compute_overshoot</span><span class="p">(</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">_plateau</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">time_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute pressure overshoot when changing pressure level.&quot;&quot;&quot;</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">context</span>
    <span class="n">pressure_overshoot</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SEQUENCE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seq</span><span class="p">,</span> <span class="s2">&quot;transition-start&quot;</span><span class="p">]</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">time_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seq</span><span class="p">,</span> <span class="s2">&quot;transition-end&quot;</span><span class="p">]</span>
        <span class="n">t_cat</span> <span class="o">=</span> <span class="n">time_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seq</span><span class="p">,</span> <span class="s2">&quot;transition-category&quot;</span><span class="p">]</span>
        <span class="n">next_plateau</span> <span class="o">=</span> <span class="n">get_target_pressure</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span> <span class="n">seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t_cat</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">pressure_overshoot</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">next_plateau</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pressure_overshoot</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">next_plateau</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pressure-overshoot&quot;</span><span class="p">:</span> <span class="n">pressure_overshoot</span><span class="p">})</span></div>



<div class="viewcode-block" id="TransformOvershoot">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformOvershoot">[docs]</a>
<span class="k">class</span> <span class="nc">TransformOvershoot</span><span class="p">(</span><span class="n">TransformStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction step to measure the overshoot/undershoot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand on which the overshoot is to be computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransformOvershoot.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.TransformOvershoot.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">):</span>
        <span class="n">level_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-all&quot;</span>
        <span class="n">new_data_set_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-overshoot&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;screen_ts_resampled&quot;</span><span class="p">,</span> <span class="s2">&quot;plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;time-info&quot;</span><span class="p">],</span>
            <span class="n">transform_function</span><span class="o">=</span><span class="n">compute_overshoot</span><span class="p">,</span>
            <span class="n">new_data_set_id</span><span class="o">=</span><span class="n">new_data_set_id</span><span class="p">,</span>
            <span class="n">definitions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">RawDataValueDefinition</span><span class="p">(</span><span class="s2">&quot;pressure-overshoot&quot;</span><span class="p">,</span> <span class="s2">&quot;Pressure overshoot.&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExtractOvershootStats">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractOvershootStats">[docs]</a>
<span class="k">class</span> <span class="nc">ExtractOvershootStats</span><span class="p">(</span><span class="n">AggregateRawDataSetColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extraction processing step for overshoot measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand on which the overshoot measures are to be computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtractOvershootStats.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.ExtractOvershootStats.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">):</span>
        <span class="n">level_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-all&quot;</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">MeasureValueDefinitionPrototype</span><span class="p">(</span>
            <span class="n">measure_name</span><span class="o">=</span><span class="n">AV</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2"> pressure overshoot&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-pressure_overshoot&quot;</span>
            <span class="p">),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The {{aggregation}} overshoot. The overshoot is &quot;</span>
            <span class="s2">&quot;defined as the extra force being used when going&quot;</span>
            <span class="s2">&quot;from one target to the next one.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-overshoot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pressure-overshoot&quot;</span><span class="p">,</span>
            <span class="n">aggregations</span><span class="o">=</span><span class="n">DEFAULT_AGGREGATIONS</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">LevelIdFilter</span><span class="p">(</span><span class="n">level_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILTER_INCOMPLETE_SEQUENCES</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GripTremorMeasures">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.GripTremorMeasures">[docs]</a>
<span class="k">class</span> <span class="nc">GripTremorMeasures</span><span class="p">(</span><span class="n">ProcessingStepGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A group of grip processing steps for tremor measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hand</span>
<span class="sd">        The hand on which the tremor measures are to be computed.</span>
<span class="sd">    sensor</span>
<span class="sd">        The sensor on which the tremor measures are to be computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GripTremorMeasures.__init__">
<a class="viewcode-back" href="../../../../../api/dispel.providers.ads.tasks.grip.html#dispel.providers.ads.tasks.grip.GripTremorMeasures.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">HandModality</span><span class="p">,</span> <span class="n">sensor</span><span class="p">:</span> <span class="n">SensorModality</span><span class="p">):</span>
        <span class="n">data_set_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sensor</span><span class="p">)</span>
        <span class="n">level_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hand</span><span class="o">.</span><span class="n">abbr</span><span class="si">}</span><span class="s2">-all&quot;</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">RenameColumns</span><span class="p">(</span><span class="n">data_set_id</span><span class="p">,</span> <span class="n">level_id</span><span class="p">,</span> <span class="o">**</span><span class="n">USER_ACC_MAP</span><span class="p">),</span>
            <span class="n">SetTimestampIndex</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_set_id</span><span class="si">}</span><span class="s2">_renamed&quot;</span><span class="p">,</span> <span class="n">DEFAULT_COLUMNS</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;last&quot;</span>
            <span class="p">),</span>
            <span class="n">Resample</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_set_id</span><span class="si">}</span><span class="s2">_renamed_ts&quot;</span><span class="p">,</span>
                <span class="n">aggregations</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;ffill&quot;</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">DEFAULT_COLUMNS</span><span class="p">,</span>
                <span class="n">freq</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">TremorMeasures</span><span class="p">(</span>
                <span class="n">sensor</span><span class="o">=</span><span class="n">sensor</span><span class="p">,</span> <span class="n">data_set_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_set_id</span><span class="si">}</span><span class="s2">_renamed_ts_resampled&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">steps</span><span class="p">,</span>
            <span class="n">task_name</span><span class="o">=</span><span class="n">TASK_NAME</span><span class="p">,</span>
            <span class="n">modalities</span><span class="o">=</span><span class="p">[</span><span class="n">hand</span><span class="o">.</span><span class="n">av</span><span class="p">],</span>
            <span class="n">hand</span><span class="o">=</span><span class="n">hand</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">level_id</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<span class="n">STEPS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProcessingStep</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_hand</span> <span class="ow">in</span> <span class="n">HandModality</span><span class="p">:</span>
    <span class="n">_hand_abbr</span> <span class="o">=</span> <span class="n">_hand</span><span class="o">.</span><span class="n">abbr</span>
    <span class="n">_level_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">_hand_abbr</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_hand_abbr</span><span class="si">}</span><span class="s2">-0</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
    <span class="n">_level_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_hand_abbr</span><span class="si">}</span><span class="s2">-all&quot;</span>

    <span class="c1"># generic steps</span>
    <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="c1"># transformation</span>
        <span class="n">ConcatenateLevels</span><span class="p">(</span>
            <span class="n">_level_id</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span> <span class="s2">&quot;accelerometer&quot;</span><span class="p">,</span> <span class="s2">&quot;gyroscope&quot;</span><span class="p">],</span> <span class="n">level_filter</span><span class="o">=</span><span class="n">_level_ids</span>
        <span class="p">),</span>
        <span class="n">SetTimestampIndex</span><span class="p">(</span>
            <span class="s2">&quot;screen&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">],</span> <span class="s2">&quot;tsTouch&quot;</span><span class="p">,</span> <span class="n">level_filter</span><span class="o">=</span><span class="n">_level_id</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;last&quot;</span>
        <span class="p">),</span>
        <span class="n">Resample</span><span class="p">(</span>
            <span class="n">data_set_id</span><span class="o">=</span><span class="s2">&quot;screen_ts&quot;</span><span class="p">,</span>
            <span class="n">aggregations</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">],</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">FREQ_100HZ</span><span class="p">,</span>
            <span class="n">level_filter</span><span class="o">=</span><span class="n">_level_id</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">TransformPlateau</span><span class="p">(</span><span class="n">_level_id</span><span class="p">),</span>
        <span class="n">TransformRefinedTargetCategory</span><span class="p">(</span><span class="n">_level_id</span><span class="p">),</span>
        <span class="n">TransformPressureError</span><span class="p">(</span><span class="n">_level_id</span><span class="p">),</span>
        <span class="n">TransformTimeRelatedInfo</span><span class="p">(</span><span class="n">_level_id</span><span class="p">),</span>
        <span class="n">TransformOvershoot</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
        <span class="c1"># extraction</span>
        <span class="n">ExtractRMSPressure</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
        <span class="n">ExtractAppliedForceStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
        <span class="n">ExtractMeanAppliedForceDiff</span><span class="p">(</span>
            <span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span>
            <span class="n">categories_to_diff</span><span class="o">=</span><span class="n">CategoryToDiff</span><span class="p">(</span>
                <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">VERY_HIGH</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">ExtractReactionTimeStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
        <span class="n">ExtractThumbPositionVariation</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
        <span class="n">ExtractOvershootStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">_plateau</span> <span class="ow">in</span> <span class="n">PlateauModality</span><span class="p">:</span>
        <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="c1"># Transformation</span>
            <span class="c1"># Time defined plateau definition scenarios</span>
            <span class="n">TransformTimeDefinedPlateau</span><span class="p">(</span><span class="n">_level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="n">TransformRefinedTargetCategory</span><span class="p">(</span><span class="n">_level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="n">TransformPressureError</span><span class="p">(</span><span class="n">_level_id</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="c1"># Extraction</span>
            <span class="n">ExtractRMSPressure</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="n">ExtractAppliedForceStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="n">ExtractMeanAppliedForceDiff</span><span class="p">(</span>
                <span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span>
                <span class="n">categories_to_diff</span><span class="o">=</span><span class="n">CategoryToDiff</span><span class="p">(</span>
                    <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span> <span class="n">TargetPressureModality</span><span class="o">.</span><span class="n">VERY_HIGH</span>
                <span class="p">),</span>
                <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>

    <span class="c1"># add pressure category specific extractions</span>
    <span class="k">for</span> <span class="n">_cat</span> <span class="ow">in</span> <span class="n">TargetPressureModality</span><span class="p">:</span>
        <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">ExtractRMSPressure</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_cat</span><span class="p">),</span>
            <span class="n">ExtractAppliedForceStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_cat</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">_plateau</span> <span class="ow">in</span> <span class="n">PlateauModality</span><span class="p">:</span>
            <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">ExtractRMSPressure</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_cat</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
                <span class="n">ExtractAppliedForceStats</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_cat</span><span class="p">,</span> <span class="n">plateau</span><span class="o">=</span><span class="n">_plateau</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="c1"># transition specific extractions</span>
        <span class="k">for</span> <span class="n">_cat_to</span> <span class="ow">in</span> <span class="n">TargetPressureModality</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_cat</span> <span class="o">!=</span> <span class="n">_cat_to</span><span class="p">:</span>
                <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ExtractTransitionTime</span><span class="p">(</span><span class="n">hand</span><span class="o">=</span><span class="n">_hand</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="p">(</span><span class="n">_cat</span><span class="p">,</span> <span class="n">_cat_to</span><span class="p">))]</span>
    <span class="n">STEPS</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="n">GripTremorMeasures</span><span class="p">(</span><span class="n">_hand</span><span class="p">,</span> <span class="n">sensor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SensorModality</span><span class="o">.</span><span class="n">ACCELEROMETER</span><span class="p">,</span> <span class="n">SensorModality</span><span class="o">.</span><span class="n">GYROSCOPE</span><span class="p">]</span>
    <span class="p">]</span>

<span class="n">STEPS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ProcessingStepGroup</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">STEPS</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="n">TASK_NAME</span><span class="p">)]</span>

<span class="n">process_grip</span> <span class="o">=</span> <span class="n">process_factory</span><span class="p">(</span>
    <span class="n">task_name</span><span class="o">=</span><span class="n">TASK_NAME</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">STEPS</span><span class="p">,</span>
    <span class="n">codes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;gripForce&quot;</span><span class="p">,</span> <span class="s2">&quot;gripForce-test&quot;</span><span class="p">),</span>
    <span class="n">supported_type</span><span class="o">=</span><span class="n">ADSReading</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>